version: v1.0
name: Icepeak Pipeline
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804

blocks:
  - name: "Install and cache GHC"
    task:
      env_vars:
        - name: PIPENV_VENV_IN_PROJECT
          value: "true"
      prologue:
        commands:
          - sudo apt install libgmp-dev

      jobs:
      - name: Install and cache dependencies for server
        commands:
          - cache restore server-stack-$SEMAPHORE_GIT_BRANCH
          - checkout
          - cd server
          - stack setup -j8 --no-terminal
          - cd
          - cache store server-stack-$SEMAPHORE_GIT_BRANCH .stack

      - name: Install and cache dependencies for client
        commands:
          - cache restore client-stack-$SEMAPHORE_GIT_BRANCH
          - checkout
          - cd client-haskell
          - stack setup -j8 --no-terminal
          - cd
          - cache store client-stack-$SEMAPHORE_GIT_BRANCH .stack

  - name: "Compile and test"
    task:
      prologue:
        commands:
          - sudo apt install libgmp-dev

      jobs:
      - name: Compile server and run tests
        commands:
          - cache restore server-stack-$SEMAPHORE_GIT_BRANCH

          - checkout
          - cd server
          - cache restore server-stack-work-$SEMAPHORE_GIT_BRANCH

          - stack build -j8 --no-terminal
          - stack test -j8 --no-terminal

          - cache store server-stack-work-$SEMAPHORE_GIT_BRANCH .stack-work
          - cd
          - cache store server-stack-$SEMAPHORE_GIT_BRANCH .stack

      - name: Compile client and run tests
        commands:
          - cache restore client-stack-$SEMAPHORE_GIT_BRANCH

          - checkout
          - cd client-haskell
          - cache restore client-stack-work-$SEMAPHORE_GIT_BRANCH

          - stack build -j8 --no-terminal
          - stack test -j8 --no-terminal

          - cache store client-stack-work-$SEMAPHORE_GIT_BRANCH .stack-work
          - cd
          - cache store client-stack-$SEMAPHORE_GIT_BRANCH .stack
