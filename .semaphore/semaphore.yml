version: v1.0
name: Icepeak Pipeline
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804

# Define a maximum running time for the sum of all jobs.
# This means that both jobs can take 10 minutes, or one can take 15 and the
# other 5, or some other combination.
execution_time_limit:
  minutes: 20

blocks:
  - name: "Compile and test icepeak"
    task:
      prologue:
        commands:
          - sudo apt install libgmp-dev
          - checkout

      jobs:
      - name: Compile server and run tests
        commands:
          - cd server
          - export PACKAGE_YAML_SUM=$(checksum package.yaml)
          - export STACK_YAML_SUM=$(checksum stack.yaml)
          - cd
          - cache restore server-stack-$PACKAGE_YAML_SUM-$STACK_YAML_SUM
          - cd -
          - cache restore server-stack-work-$PACKAGE_YAML_SUM-$STACK_YAML_SUM

          - stack build -j8 --no-terminal
          - stack test -j8 --no-terminal

          - cache store server-stack-work-$PACKAGE_YAML_SUM-$STACK_YAML_SUM .stack-work
          - cd
          - cache store server-stack-$PACKAGE_YAML_SUM-$STACK_YAML_SUM .stack

      - name: Compile client and run tests
        commands:
          - cd client-haskell
          - export PACKAGE_YAML_SUM=$(checksum package.yaml)
          - export STACK_YAML_SUM=$(checksum stack.yaml)
          - cd
          - cache restore client-stack-$PACKAGE_YAML_SUM-$STACK_YAML_SUM
          - cd -
          - cache restore client-stack-work-$PACKAGE_YAML_SUM-$STACK_YAML_SUM

          - stack build -j8 --no-terminal
          - stack test -j8 --no-terminal

          - cache store client-stack-work-$PACKAGE_YAML_SUM-$STACK_YAML_SUM .stack-work
          - cd
          - cache store client-stack-$PACKAGE_YAML_SUM-$STACK_YAML_SUM .stack
